@inject IRoleService RoleService
@inject IUserService UserService
@inject NavigationManager NavigationManager
@using Hexalith.Security.Application
@using Labels = Hexalith.Security.UI.Components.Resources.UserRoles.UserRoles
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Labels> L


@if (_roles is null)
{
	<FluentProgressRing />
}
else
{
	<FluentDataGrid TGridItem="RoleSummaryViewModel"
					Items="@_roles.AsQueryable()"
					ResizableColumns="true"
					OnRowDoubleClick="HandleRowClick">
		<PropertyColumn Property="@(p => p.Id)" Title="@L[nameof(Labels.Id)]" />
		<PropertyColumn Property="@(p => p.Name)" Title="@L[nameof(Labels.Name)]" />
		<TemplateColumn Title="@(L[nameof(Labels.Selected)])">
			<FluentCheckbox Value="@IsUserRole(context.Id)" ValueChanged="@(() => ToggleUserRole(context.Id))" />
		</TemplateColumn>
	</FluentDataGrid>
}

@code {
	[Parameter]
	public EventCallback<string> OnRoleClick { get; set; }
	[Parameter]
	[EditorRequired]
	public required string UserId { get; set; }

	private IEnumerable<string>? _userRoleIds;
	private IEnumerable<RoleSummaryViewModel>? _roles;

	protected override async Task OnInitializedAsync()
	{
		_userRoleIds = await UserService.GetUserRolesAsync(UserId, CancellationToken.None);
		_roles = await RoleService.GetAllAsync(CancellationToken.None);
		await base.OnInitializedAsync();
	}
	private bool IsUserRole(string roleId)
	{
		return _userRoleIds?.Contains(roleId) ?? false;
	}

	private async Task ToggleUserRole(string roleId)
	{
		ArgumentException.ThrowIfNullOrWhiteSpace(roleId);
		if (_userRoleIds is null)
			_userRoleIds = [];
		if (IsUserRole(roleId))
		{
			await UserService.RemoveRoleAsync(UserId, roleId, CancellationToken.None);
			_userRoleIds = [.. _userRoleIds.Where(p => p != roleId)];
		}
		else
		{
			await UserService.AddRoleAsync(UserId, roleId, CancellationToken.None);
			_userRoleIds = [.. _userRoleIds.Append(roleId)];
		}
	}

	private void HandleRowClick(FluentDataGridRow<RoleSummaryViewModel> args)
	{
		NavigationManager.NavigateTo($"/Security/Role/{args.Id}");
	}
}
